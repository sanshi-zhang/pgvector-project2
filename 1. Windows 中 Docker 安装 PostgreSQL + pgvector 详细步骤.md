# Windows 中 Docker 安装 PostgreSQL + pgvector 详细步骤

## 第一部分：Docker 安装和配置

### 步骤1：安装 Docker Desktop

1. **下载 Docker Desktop**
   - 访问：https://www.docker.com/products/docker-desktop/
   - 点击 "Download for Windows"
   - 下载稳定版（Stable）

2. **安装 Docker Desktop**
   - 双击安装文件运行
   - 安装过程中勾选这些选项：
     - ✅ 安装 WSL 2（Windows 10/11 必需）
     - ✅ 将 Docker Desktop 添加到桌面快捷方式
   - 按照提示重启电脑（必须）

3. **启动 Docker Desktop**
   - 双击桌面上的 Docker Desktop 图标
   - 首次启动需要一些时间（5-10分钟）
   - 出现以下界面表示安装成功：
   ```
   ✔ Docker Desktop is running
   ```

### 步骤2：验证 Docker 安装
打开 PowerShell（管理员身份）：
```powershell
# 检查 Docker 版本
docker --version
# 应该显示：Docker version 24.0.7 或更高

# 运行测试容器
docker run hello-world
# 看到 "Hello from Docker!" 表示成功
```

## 第二部分：运行 PostgreSQL + pgvector 容器

### 步骤1：创建项目目录
```powershell
# 在桌面创建项目文件夹
mkdir C:\Users\你的用户名\Desktop\pgvector-project
cd C:\Users\你的用户名\Desktop\pgvector-project
```

### 步骤2：创建 docker-compose.yml 文件
用记事本创建新文件，保存为 `docker-compose.yml`，内容如下：

```yaml
version: '3.8'

services:
  postgres:
    image: pgvector/pgvector:pg16  # 包含pgvector的官方镜像
    container_name: postgres_vector
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pass123  # 改为你的密码
      POSTGRES_DB: vector_db
    ports:
      - "5432:5432"  # 本地端口:容器端口
    volumes:
      - postgres_data:/var/lib/postgresql/data  # 数据持久化
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql  # 初始化脚本
    restart: unless-stopped

volumes:
  postgres_data:  # Docker卷，保存数据库数据
```

### 步骤3：创建初始化脚本
在同一目录下创建 `init.sql` 文件，内容：
```sql
-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 创建测试表
CREATE TABLE IF NOT EXISTS items (
    id BIGSERIAL PRIMARY KEY,
    embedding VECTOR(3),  -- 3维向量
    content TEXT
);

-- 插入测试数据
INSERT INTO items (embedding, content) VALUES
('[1,1,1]', '苹果'),
('[2,2,2]', '香蕉'),
('[3,3,3]', '橙子'),
('[4,4,4]', '葡萄');

-- 创建向量索引（可选）
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

### 步骤4：启动容器
```powershell
# 在项目目录下运行
docker-compose up -d

# 查看容器状态
docker ps
```
应该看到：
```
CONTAINER ID   IMAGE                     STATUS         PORTS
xxxxxxxxxxxx   pgvector/pgvector:pg16   Up 2 seconds   0.0.0.0:5432->5432/tcp
```

## 第三部分：使用 pgAdmin 连接 Docker PostgreSQL

### 步骤1：安装 pgAdmin4
1. 访问：https://www.pgadmin.org/download/pgadmin-4-windows/
2. 下载最新版安装程序
3. 运行安装，全部默认设置

### 步骤2：配置 pgAdmin 连接

1. **打开 pgAdmin4**
   - 从开始菜单启动 pgAdmin4
   - 首次启动会要求设置主密码（pass123）

2. **注册新服务器**
   - 右键点击 "Servers" → "Register" → "Server"
   
3. **填写连接信息：**

   **General 标签页：**
   - Name: `Docker PostgreSQL`（任意名称）
   
   **Connection 标签页：**
   ```
   Host name/address: localhost
   Port: 5432
   Maintenance database: vector_db  # 或 postgres
   Username: postgres
   Password: pass123  # 你设置的密码
   ```

   **保存并连接**
   - 点击 "Save"
   - 如果看到连接成功，左侧会出现服务器图标

### 步骤3：验证连接
1. 在 pgAdmin 左侧展开：
   ```
   Servers → Docker PostgreSQL → Databases → vector_db → Schemas → public → Tables
   ```
2. 应该看到 `items` 表
3. 右键点击 `items` 表 → "View/Edit Data" → "All Rows"
4. 应该看到我们插入的4条测试数据

## 第四部分：测试和验证

### 测试1：使用 Docker 命令行测试
```powershell
# 进入容器内的bash
docker exec -it postgres_vector bash

# 连接到PostgreSQL
psql -U postgres -d vector_db

# 在psql中执行以下命令：
```

```sql
-- 查看已安装扩展
\dx

-- 查看表结构
\d items

-- 测试向量搜索
SELECT 
    id, 
    content, 
    embedding <-> '[1.5,1.5,1.5]' as distance
FROM items 
ORDER BY embedding <-> '[1.5,1.5,1.5]'
LIMIT 3;

-- 应该看到最接近[1.5,1.5,1.5]的向量是苹果([1,1,1])
```

### 测试2：使用 pgAdmin 查询工具

在 pgAdmin 中：
1. 右键点击 `vector_db` → "Query Tool"
2. 输入以下 SQL：

```sql
-- 测试余弦相似度
SELECT 
    id,
    content,
    1 - (embedding <=> '[1.5,1.5,1.5]') as similarity
FROM items 
ORDER BY embedding <=> '[1.5,1.5,1.5]'
LIMIT 3;

-- 测试欧几里得距离（默认）
SELECT * FROM items 
ORDER BY embedding <-> '[2.1,2.1,2.1]' 
LIMIT 3;

-- 添加更多数据
INSERT INTO items (embedding, content) 
VALUES 
('[5,5,5]', '芒果'),
('[0.5,0.5,0.5]', '樱桃');

-- 验证数据
SELECT COUNT(*) FROM items;  -- 应该是6条记录
```

### 测试3：创建更复杂的向量示例

```sql
-- 创建文档向量表
CREATE TABLE IF NOT EXISTS documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    embedding VECTOR(384)  -- 常用维度，如sentence-transformers
);

-- 插入模拟数据
INSERT INTO documents (title, content, embedding) VALUES
('机器学习简介', '机器学习是人工智能的核心...', '[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0]'::vector || array_fill(0.1, ARRAY[374])::vector),
('深度学习基础', '深度学习使用神经网络...', '[0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0,0.1]'::vector || array_fill(0.2, ARRAY[374])::vector);

-- 向量相似度搜索
SELECT 
    title,
    1 - (embedding <=> (SELECT embedding FROM documents WHERE title = '机器学习简介')) as similarity
FROM documents
WHERE title != '机器学习简介'
ORDER BY similarity DESC;
```

## 第五部分：日常使用命令

### Docker 管理命令：
```powershell
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 查看日志
docker logs postgres_vector

# 备份数据库
docker exec postgres_vector pg_dump -U postgres vector_db > backup.sql

# 重启服务
docker-compose restart

# 进入数据库命令行
docker exec -it postgres_vector psql -U postgres -d vector_db
```

### 故障排除：

1. **端口冲突错误**（如果 5432 端口被占用）：
```yaml
# 修改 docker-compose.yml 中的端口映射
ports:
  - "5433:5432"  # 使用5433端口
```

2. **连接被拒绝**：
```powershell
# 检查容器状态
docker ps

# 查看容器日志
docker logs postgres_vector

# 重启 Docker Desktop
```

3. **忘记密码**：
```powershell
# 进入容器bash
docker exec -it postgres_vector bash

# 重新设置密码
psql -U postgres -c "ALTER USER postgres WITH PASSWORD 'newpassword';"
```

## 第六部分：创建快捷脚本

在项目目录创建 `start.ps1`（PowerShell脚本）：
```powershell
# 启动所有服务
docker-compose up -d
Write-Host "PostgreSQL with pgvector 已启动" -ForegroundColor Green
Write-Host "连接信息：" -ForegroundColor Yellow
Write-Host "主机: localhost" -ForegroundColor Cyan
Write-Host "端口: 5432" -ForegroundColor Cyan
Write-Host "用户名: postgres" -ForegroundColor Cyan
Write-Host "密码: postgres123" -ForegroundColor Cyan
Write-Host "数据库: vector_db" -ForegroundColor Cyan
Write-Host ""
Write-Host "使用 pgAdmin 连接或运行: docker exec -it postgres_vector psql -U postgres -d vector_db"
```

创建 `stop.ps1`：
```powershell
# 停止服务
docker-compose down
Write-Host "服务已停止" -ForegroundColor Yellow
```

## 验证清单

完成所有步骤后，检查以下项目：

- [ ] Docker Desktop 运行正常
- [ ] `docker ps` 显示 postgres_vector 容器
- [ ] pgAdmin 可以成功连接到 localhost:5432
- [ ] 可以执行基本的 SQL 查询
- [ ] `\dx` 显示 vector 扩展已安装
- [ ] 可以执行向量相似度查询

## 后续步骤

1. **导入真实数据**：
```sql
-- 使用COPY命令导入CSV
COPY items(embedding, content) 
FROM '/path/to/data.csv' 
DELIMITER ',' CSV;
```

2. **性能优化**：
```sql
-- 创建HNSW索引（PostgreSQL 17+）
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);

-- 调整配置
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET maintenance_work_mem = '512MB';
```

3. **备份策略**：
```powershell
# 每天自动备份
docker exec postgres_vector pg_dump -U postgres vector_db | gzip > backup_$(date +%Y%m%d).sql.gz
```

现在你已经有了完整的 PostgreSQL + pgvector 环境，可以开始进行向量数据库的开发工作了！